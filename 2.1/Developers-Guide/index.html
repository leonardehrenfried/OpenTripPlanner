<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://docs.opentripplanner.org/2.1/Developers-Guide/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Developers' Guide - OpenTripPlanner 2</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/version-select.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">OpenTripPlanner 2</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Governance/" class="dropdown-item">Governance</a>
</li>
                                    
<li>
    <a href="../History/" class="dropdown-item">History</a>
</li>
                                    
<li>
    <a href="../Deployments/" class="dropdown-item">Deployments</a>
</li>
                                    
<li>
    <a href="../Changelog/" class="dropdown-item">Changelog</a>
</li>
                                    
<li>
    <a href="../Version-Comparison/" class="dropdown-item">Comparing OTP2 to OTP1</a>
</li>
                                    
<li>
    <a href="../OTP2-MigrationGuide/" class="dropdown-item">OTP2 migration guide</a>
</li>
                                    
<li>
    <a href="../Visual-Identity/" class="dropdown-item">Visual Identity</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Usage <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Basic-Tutorial/" class="dropdown-item">Basic Tutorial</a>
</li>
                                    
<li>
    <a href="../Getting-OTP/" class="dropdown-item">Getting OTP</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Configuration</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../Configuration/" class="dropdown-item">Introduction</a>
</li>
            
<li>
    <a href="../BuildConfiguration/" class="dropdown-item">Build</a>
</li>
            
<li>
    <a href="../RouterConfiguration/" class="dropdown-item">Router</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../Preparing-OSM/" class="dropdown-item">Preparing OSM Data</a>
</li>
                                    
<li>
    <a href="../Netex-Norway/" class="dropdown-item">Netex and SIRI</a>
</li>
                                    
<li>
    <a href="../Security/" class="dropdown-item">Security</a>
</li>
                                    
<li>
    <a href="../Troubleshooting-Routing/" class="dropdown-item">Troubleshooting</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Development <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Developers' Guide</a>
</li>
                                    
<li>
    <a href="../Interfaces-Data-Sources/" class="dropdown-item">Interfaces and Data Sources</a>
</li>
                                    
<li>
    <a href="../Localization/" class="dropdown-item">Localization</a>
</li>
                                    
<li>
    <a href="../Bibliography/" class="dropdown-item">Bibliography</a>
</li>
                                    
<li>
    <a href="../Codestyle/" class="dropdown-item">Codestyle</a>
</li>
                                    
<li>
    <a href="../SandboxExtension/" class="dropdown-item">Sandbox development</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Sandbox <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../SandboxExtension/" class="dropdown-item">About</a>
</li>
                                    
<li>
    <a href="../sandbox/ActuatorAPI/" class="dropdown-item">Actuator API</a>
</li>
                                    
<li>
    <a href="../sandbox/transferanalyzer/" class="dropdown-item">Direct transfer analyzer</a>
</li>
                                    
<li>
    <a href="../sandbox/GoogleCloudStorage/" class="dropdown-item">Google Cloud Storage</a>
</li>
                                    
<li>
    <a href="../sandbox/LegacyGraphQLApi/" class="dropdown-item">HSL Legacy GraphQL API</a>
</li>
                                    
<li>
    <a href="../sandbox/TransmodelApi/" class="dropdown-item">Transmodel(NeTEx) GraphQL API</a>
</li>
                                    
<li>
    <a href="../sandbox/SiriUpdator/" class="dropdown-item">SIRI Updater</a>
</li>
                                    
<li>
    <a href="../sandbox/VehicleRentalServiceDirectory/" class="dropdown-item">Vehicle Rental Service Directory API support</a>
</li>
                                    
<li>
    <a href="../sandbox/SmooveBikeRental/" class="dropdown-item">Smoove Bike Rental Updator Support</a>
</li>
                                    
<li>
    <a href="../sandbox/MapboxVectorTilesApi/" class="dropdown-item">Mapbox Vector Tiles API</a>
</li>
                                    
<li>
    <a href="../sandbox/Flex/" class="dropdown-item">Flex Routing</a>
</li>
                                    
<li>
    <a href="../sandbox/ReportApi/" class="dropdown-item">Report API</a>
</li>
                                    
<li>
    <a href="../sandbox/InteractiveOtpMain/" class="dropdown-item">Interactive OTP Launcher</a>
</li>
                                    
<li>
    <a href="../sandbox/Examples/" class="dropdown-item">Sandbox Extension Example</a>
</li>
                                    
<li>
    <a href="../sandbox/ParkAndRideApi/" class="dropdown-item">Park and Ride API</a>
</li>
                                    
<li>
    <a href="../sandbox/DataOverlay/" class="dropdown-item">Data Overlay</a>
</li>
                                    
<li>
    <a href="../sandbox/VehicleParking/" class="dropdown-item">Vehicle Parking Updaters</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../Troubleshooting-Routing/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Interfaces-Data-Sources/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="http://github.com/opentripplanner/OpenTripPlanner/edit/master/docs/Developers-Guide.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#developers-guide" class="nav-link">Developers Guide</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#quick-setup" class="nav-link">Quick setup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#working-on-otp-in-an-ide" class="nav-link">Working on OTP in an IDE</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#contributing-to-the-project" class="nav-link">Contributing to the project</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#code-style" class="nav-link">Code style</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#continuous-integration" class="nav-link">Continuous Integration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#release-process" class="nav-link">Release Process</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="developers-guide">Developers Guide</h1>
<h2 id="quick-setup">Quick setup</h2>
<p><em>A Quick guide to setting up the OpenTripPlanner project.</em></p>
<p>You need Git, Maven and Java(JDK) and an IDE installed on your computer. You IDE might have JDK and 
Maven embedded, if so you may skip step 3.</p>
<ol>
<li>Clone OpenTripPlanner from GitHub.</li>
<li>Checkout the desired branch <code>git checkout dev-2.x</code> </li>
<li>Run <code>maven package</code>- this will download all dependencies, build the project and run tests.</li>
<li>Open the project in your IDE.</li>
<li>Import the <em>intellij-code-style.xml</em> (IntelliJ IDE).</li>
</ol>
<h2 id="working-on-otp-in-an-ide">Working on OTP in an IDE</h2>
<p>Most people writing or modifying OTP code use an Integrated Development Environment (IDE). Some of 
the most popular IDEs for Java development are <a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a>, 
<a href="http://eclipse.org">Eclipse</a>, and <a href="https://netbeans.org">NetBeans</a>. All three of these environments 
are good for working on OTP. IntelliJ is used by most OTP developers, and the only IDE we support 
with a code style formatter. You may choose another IDE, but Maven and Git integration is a 
plus since OTP is under Git version control and build with Maven.</p>
<p>Many of the Core OTP developers use IntelliJ IDEA. It is an excellent IDE, and in my experience is 
quicker and more stable than the competition. IntelliJ IDEA is a commercial product, but there is an 
open source "community edition" that is completely sufficient for working on OTP.</p>
<p>Rather than using the version control support in my IDE, I usually find it more straightforward to clone the OTP GitHub
repository manually (on the command line or using some other Git interface tool), then import the resulting local OTP
repository into my IDE as a Maven project. The IDE should then take care of fetching all the libraries OTP depends on,
based on the Maven project description (POM file) in the base of the OTP repository. This step can take a long time because
it involves downloading a lot of JAR files.</p>
<p>When running your local copy of the OTP source within an IDE, all command line switches and 
configuration options will be identical to the ones used when running the OTP JAR from the command
line (as described in the <a href="../Basic-Tutorial/">OpenTripPlanner Basic Tutorial</a> and 
<a href="../Configuration/">configuration reference</a>). The only difference is that you need to manually 
specify the main class. When you run a JAR from the command line, the JVM automatically knows which 
class contains the entry point into the program (the <code>main</code> function), but in IDEs you must create 
a "run configuration".</p>
<p>Both IntelliJ and Eclipse have "run" menus, from which you can select an option to edit the run configurations.
You want to create a configuration for a Java Application, specifying the main class
<code>org.opentripplanner.standalone.OTPMain</code>. Unlike on the command line, the arguments to the JVM and to the main class
you are running are specified separately. In the field for the VM options you'll want to put your maximum memory
parameter (<code>-Xmx2G</code>, or whatever limit you want to place on JVM memory usage). The rest of the parameters to OTP itself
will go in a different field with a name like "program arguments".</p>
<h2 id="contributing-to-the-project">Contributing to the project</h2>
<p>OpenTripPlanner is a community based open source project, and we welcome all who wish to contribute.
There are several ways to get involved:</p>
<ul>
<li>
<p>Join the <a href="http://groups.google.com/group/opentripplanner-dev">developer mailing list</a></p>
</li>
<li>
<p>Fix typos and improve the documentation within the <code>/docs</code> directory of the project (details below).</p>
</li>
<li>
<p><a href="http://github.com/openplans/OpenTripPlanner/issues/new">File a bug or new feature request</a>.</p>
</li>
<li>
<p>Submit patches. If you're not yet a committer, please provide patches as pull requests citing the relevant issue.
   Even when you do have push access to the repository, pull requests are a good way to get feedback on changes.</p>
</li>
</ul>
<h3 id="branches-and-branch-protection">Branches and Branch Protection</h3>
<p>As of January 2019, we have begun work on OTP 2.x and are using a Git branching model derived from <a href="https://nvie.com/posts/a-successful-git-branching-model/">Gitflow</a>. All development will occur on the <code>dev-1.x</code> and <code>dev-2.x</code> branches. Only release commits setting the Maven artifact version to a non-snapshot number should be pushed to the <code>master</code> branch of OTP. All other changes to master should result from fast-forward merges of a Github pull request from the <code>dev-1.x</code> branch. In turn, all changes to <code>dev-1.x</code> should result from a fast-forward merge of a Github pull request for a single feature, fix, or other change. These pull requests are subject to code review. We require two pull request approvals from OTP leadership committee members or designated code reviewers from two different organizations. We also have validation rules ensuring that the code compiles and all tests pass before pull requests can be merged.</p>
<p>The <code>dev-2.x</code> branch is managed similarly to <code>dev-1.x</code> but because it's rapidly changing experimental code worked on by relatively few people, we require only one pull request approval from a different organization than the author. Merges will not occur into <code>master</code> from <code>dev-2.x</code> until that branch is sufficiently advanced and receives approval from the OTP project leadership committee.</p>
<h3 id="issues-and-commits">Issues and commits</h3>
<p>All commits should reference a specific issue number (this was formally decided in issue #175).
For example, <code>Simplify module X configuration #9999</code>.
If no ticket exists for the feature or bug your code implements or fixes,
you should <a href="http://github.com/openplans/OpenTripPlanner/issues/new">create a new ticket</a> prior to checking in, or
ideally even prior to your development work since this provides a place to carry out implementation discussions (in the comments).</p>
<p>GitHub will automatically update issues when commits are merged in: if your commit message includes the text
<code>fixes #123</code>, it will automatically append your message as a comment on the isse and close it.
If you simply mention <code>#123</code> in your message, your message will be appended to the issue but it will remain open.
Many other expressions exist to close issues via commit messages. See <a href="https://help.github.com/articles/closing-issues-via-commit-messages/">the GitHub help page on this topic</a>.</p>
<h3 id="unit-tests-using-real-osm-data">Unit tests using real OSM data</h3>
<p>Sometimes it is useful to build a graph from actual OSM or GTFS data. Since building these graphs
in a test can be quite slow they will be accepted in pull requests only if they conform to certain
standards:</p>
<ol>
<li>
<p>Use the smallest possible regional extract - the OSM file should not contain more than a few hundred ways.
   Use <code>osmium-extract</code> to cut down a larger OSM file into a tiny subset of it.</p>
</li>
<li>
<p>Strip out any unneeded information by using the <code>osmium filter-tags</code> as describe in <a href="../Preparing-OSM/">Preparing OSM</a></p>
</li>
</ol>
<h3 id="code-comments">Code Comments</h3>
<p>As a matter of <a href="http://github.com/opentripplanner/OpenTripPlanner/issues/93">policy</a>, all new 
methods, classes, and fields should include comments explaining what they are for and any other
pertinent information. For Java code, the comments should use the 
<a href="http://java.sun.com/j2se/javadoc/writingdoccomments">JavaDoc conventions</a>. It is best to provide
comments that not only explain <em>what</em> you did but also <em>why you did it</em> while providing some
context. Please avoid including trivial Javadoc or the empty Javadoc stubs added by IDEs, such as
<code>@param</code> annotations with no description.</p>
<h3 id="itinerary-and-api-snapshot-tests">Itinerary and API Snapshot Tests</h3>
<p>To test the itinerary generation, and the API there are snapshot test which save the result of the
requests as <code>*.snap</code> JSON-like files. These are stored in git so that it is possible to compare to
the expected result when running the tests.</p>
<p>If the snapshots need to be recreated than running <code>mvn clean -Pclean-test-snapshots</code> will remove
the existing <code>*.snap</code> files so that the next time the tests are run the snapshots will be recreated.
The updated files may be committed after checking that the changes in the files are expected.</p>
<h3 id="documentation">Documentation</h3>
<p>OTP documentation is included directly in the OpenTripPlanner repository. 
This allows version control to be applied to documentation as well as program source code.
All pull requests that change how OTP is used or configured should include changes to the
documentation alongside code modifications. </p>
<p>The documentation files are in Markdown format and are in the <code>/docs</code> directory under the root of 
the project. On every push to the master branch the documentation will be rebuilt and deployed as 
static pages to our subdomain of <a href="http://opentripplanner.readthedocs.org/">ReadTheDocs</a>. MkDocs is 
a Python program and should run on any major platform. See http://www.mkdocs.org/ for information on
how to install it and how to generate a live local preview of the documentation while you're working
on writing it.</p>
<p>In short:</p>
<pre><code>$ pip install mkdocs
$ mkdocs serve
</code></pre>
<p>The OTP REST API documentation is available online in the format of:</p>
<p>http://dev.opentripplanner.org/apidoc/x.x.x/index.html</p>
<p>For example, for v2.1.0:</p>
<p>http://dev.opentripplanner.org/apidoc/2.1.0/index.html</p>
<h3 id="debug-layers">Debug layers</h3>
<p>Adding new renderer is very easy. You just need to create new class (preferably in
<code>org.opentripplanner.inspector</code> package) which implements EdgeVertexRenderer. It is best if class
name ends with Rendered. To implement this interface you need to write three functions <code>renderEdge</code>,
<code>renderVertex</code> and <code>getName</code>. Both render functions accepts <code>EdgeVisualAttributes</code> object in which
label of edge/vertex and color can be set. And both return <code>true</code> if edge/vertex should be rendered
and <code>false</code> otherwise. <code>getName</code> function should return short descriptive name of the class and will
be shown in layer chooser.</p>
<p>For examples how to write renderers you can look into example renderers which are all in <code>org.opentripplanner.inspector</code> package.</p>
<p>After your class is written you only need to add it to TileRenderManager:</p>
<pre><code class="language-java">//This is how Wheelchair renderer is added
renderers.put(&quot;wheelchair&quot;, new EdgeVertexTileRenderer(new WheelchairEdgeRenderer()));
</code></pre>
<p><code>wheelchair</code> is internal layer key and should consist of a-zA-Z and -.</p>
<p>By default all the tiles have cache headers to cache them for one hour. This can become problematic
 if you are changing renderers a lot. To disable this change <code>GraphInspectorTileResource</code>:</p>
<pre><code class="language-java">//This lines
CacheControl cc = new CacheControl();
cc.setMaxAge(3600);
cc.setNoCache(false);

//to this:
CacheControl cc = new CacheControl();
cc.setNoCache(true);
</code></pre>
<h3 id="date-format">Date format</h3>
<p>Please use only ISO 8601 date format (YYYY-MM-DD) in documentation, comments, and throughout the 
project. This avoids the ambiguity that can result from differing local interpretations of date 
formats like 02/01/12.</p>
<h2 id="code-style">Code style</h2>
<p>The OTP code style is described on a separate <a href="../Codestyle/">style guide page</a>.</p>
<h2 id="continuous-integration">Continuous Integration</h2>
<p>The OpenTripPlanner project uses the <a href="https://travis-ci.org/opentripplanner/OpenTripPlanner">Travis CI continuous integration system</a>. Any time a change
is pushed to the main OpenTripPlanner repository on GitHub, this server will compile and test the new code, providing feedback on the stability of the build.</p>
<h3 id="changelog-workflow">Changelog workflow</h3>
<p>The <a href="https://github.com/opentripplanner/OpenTripPlanner/blob/dev-2.x/docs/Changelog.md">changelog file</a>
is generated from the pull-request(PR) <em>title</em> using the
<a href="https://github.com/opentripplanner/OpenTripPlanner/actions/workflows/automatic-changelog.yml">changelog workflow</a>.
The workflow runs after the PR is merged, and it changes, commits and pushes the <em>Changelog.md</em>. A
secret <em>personal access token</em> is used to bypass the "Require PR with 2 approvals" rule. To exclude
a PR from the changelog add <code>[changelog skip]</code> in the PR title.</p>
<h4 id="how-to-update-the-changelog_token">How-to update the CHANGELOG_TOKEN</h4>
<p>The <code>CHANGELOG_TOKEN</code> is used by the changelog workflow. It contains a Personal Access Token. The token must be generated by a Repository Owner and have the following rights (<em>Settings / Developer settings / Personal access tokens</em>):</p>
<p><img alt="Skjermbilde 2021-11-18 kl  12 08 27" src="https://user-images.githubusercontent.com/5525340/142404549-c0bf2aba-608b-4feb-a114-6e4992c57073.png" /></p>
<h2 id="release-process">Release Process</h2>
<p>This section serves as a checklist for the person performing releases. Note that much of this mimics 
the actions taken by the Maven release plugin. Based on past experience, the Maven release plugin can 
fail at various points in the process leaving the repo in a confusing state. Taking each action 
manually is more tedious, but keeps eyes on each step and is less prone to failure. Releases are 
performed off the master branch, and are tagged with git annotated tags.</p>
<p>OpenTripPlanner is released as Maven artifacts to Maven Central. These include compiled and source code JARs as well as
a "shaded" JAR containing all dependencies, allowing stand-alone usage. This release process is handled by the
Sonatype Nexus Staging plugin, configured in the OpenTripPlanner POM.</p>
<p>We no longer trigger deployment of artifacts to Maven Central or deployment of documentation to AWS automatically in build scripts. These steps are prone to failure and require storing a lot of infrequently used secret information in the repo and environment variables on GitHub. Our releases are currently not very frequent so we just carry out these steps manually by following the checklist.</p>
<ul>
<li>Check that your local copy of the dev branch is up to date with no uncommitted changes<ul>
<li><code>git status</code></li>
<li><code>git checkout dev-2.x</code></li>
<li><code>git clean -df</code></li>
<li><code>git pull</code></li>
</ul>
</li>
<li>Verify that all dependencies in the POM are non-SNAPSHOT versions</li>
<li>Update <code>docs/Changelog.md</code><ul>
<li>Lines should have been added or updated as each pull request was merged</li>
<li>If you suspect any changes are not reflected in the Changelog, review the commit log and add any missing items</li>
<li>Update the header at the top of the list from <code>x.y.z-SNAPSHOT</code> to just <code>x.y.z (current date)</code></li>
<li>Check in any changes, and push to Github</li>
</ul>
</li>
<li>Check <a href="https://github.com/opentripplanner/OpenTripPlanner/actions/workflows/">on GH Actions</a> that the build is currently passing</li>
<li>Switch to the HEAD of master branch, and ensure it's up to date with no uncommitted changes<ul>
<li><code>git checkout master</code></li>
<li><code>git status</code></li>
<li><code>git clean -df</code></li>
<li><code>git pull</code></li>
</ul>
</li>
<li>Merge the dev branch into master<ul>
<li><code>git merge dev-2.x</code> </li>
</ul>
</li>
<li>Bump the SNAPSHOT version in the POM to the release version<ul>
<li>Edit version in POM, removing SNAPSHOT and increasing version numbers as needed (following semantic versioning)</li>
<li><code>git add pom.xml</code></li>
<li><code>git commit -m "prepare release x.y.z"</code></li>
</ul>
</li>
<li>Run a test build of the release locally, without deploying it<ul>
<li><code>mvn clean install site</code></li>
<li>The <code>install</code> goal will sign the Maven artifacts so you need the GPG signing certificate set up</li>
<li>You can also use the <code>package</code> goal instead of the <code>install</code> goal to avoid signing if you don't have the GPG certificate installed.</li>
<li>All tests should pass</li>
<li>This build will also create Enunciate API docs and Javadoc with the correct non-snapshot version number</li>
</ul>
</li>
<li>Deploy the documentation to AWS S3<ul>
<li>You have to do this right after the test release build to ensure the right version number in the docs</li>
<li>You will need AWSCLI tools (<code>sudo pip install -U awscli</code>)</li>
<li>You will need AWS credentials with write access to the bucket <code>s3://dev.opentripplanner.org</code></li>
<li><code>aws s3 cp --recursive target/site/apidocs s3://dev.opentripplanner.org/javadoc/x.y.z --acl public-read</code></li>
<li><code>aws s3 cp --recursive target/site/enunciate/apidocs s3://dev.opentripplanner.org/apidoc/x.y.z --acl public-read</code></li>
<li>Check that docs are readable and show the correct version via the <a href="http://dev.opentripplanner.org">development documentation landing page</a>.</li>
</ul>
</li>
<li>Finally, if everything looks good, tag and push this release to make it official<ul>
<li><code>git tag -a vX.Y.Z -m "release X.Y.Z"</code></li>
<li><code>git push origin vX.Y.Z</code></li>
<li>Note that <strong>only one</strong> commit may have a particular non-snapshot version in the POM (this is the commit that 
  should be tagged as the release)</li>
<li>Go to the <a href="https://github.com/opentripplanner/OpenTripPlanner/tags">GitHub tags page</a> and use the <code>...</code> button to mark the new tag as a release.</li>
<li>Give the release a name like <code>v2.1.0 (March 2022)</code></li>
<li>Optionally add a very condensed version of the changelog in the description box, with only the 5-10 most significant changes that might affect someone's choice to upgrade.</li>
<li>Currently, pushing the tag does not trigger deployment of release Maven artifacts. This must be done manually. It can conceivably be configured to happen in the Actions scripts when any tag is pushed.</li>
</ul>
</li>
<li>Deploy the build artifacts to Maven Central and GitHub<ul>
<li>While still on the tag commit, run <code>mvn deploy</code> after you have completed the local build as described above.</li>
<li>This requires you to have the GPG keys and Maven repo credentials set up.</li>
<li>Attach the JAR files produced in <code>/target</code> to the GitHub release page you just created. </li>
</ul>
</li>
<li>Set up next development iteration<ul>
<li>Add a new section header to <code>docs/Changelog.md</code> like <code>x.y+1.0-SNAPSHOT (in progress)</code></li>
<li>Edit minor version in <code>pom.xml</code> to <code>x.y+1.0-SNAPSHOT</code></li>
<li><code>git add pom.xml docs/Changelog.md</code></li>
<li><code>git commit -m "Prepare next development iteration x.y+1.0-SNAPSHOT"</code></li>
<li><code>git push</code></li>
</ul>
</li>
<li>Check that Maven artifact appears on Maven Central<ul>
<li><a href="https://repo1.maven.org/maven2/org/opentripplanner/otp/">Directory listing of OTP releases on Maven Central</a></li>
<li>It may take a while (half an hour) for releases to show up in the central repo after Travis uploads the artifacts</li>
</ul>
</li>
<li>Merge master back into dev (to sync up the Maven artifact version from the POM)<ul>
<li><code>git checkout dev-2.x</code></li>
<li><code>git merge master</code></li>
<li><code>git push</code></li>
</ul>
</li>
<li>Make sure the main documentation is built<ul>
<li>For some reason it doesn't always build automatically</li>
<li>Go to <a href="http://readthedocs.org/projects/opentripplanner/builds/">builds of docs.opentripplanner.org</a></li>
<li>Click "build version: latest"</li>
</ul>
</li>
<li>Email the OTP dev and users mailing lists<ul>
<li>Mention the new version number.</li>
<li>Provide links to the new developer documentation.</li>
<li>Provide links to the artifacts directory on Maven Central.</li>
<li>Trigger build of latest OTP documentation on Readthedocs.</li>
</ul>
</li>
</ul>
<h3 id="artifact-signing">Artifact Signing</h3>
<p>Maven release artifacts must be digitally signed to prove their origin. This is a safeguard against compromised code 
from a malicious third party being disguised as a trusted library.</p>
<p>The OTP artifact signing key was created by Conveyal. We export only that signing subkey, with our company's main key 
blanked out. Therefore, even if someone managed to acquire the decrypted key file and the associated GPG passphrase, 
they would not have the main key. We could deactivate the signing key and create a new one, without the main key being 
compromised.</p>
<p>OpenTripPlanner's POM is set up to sign artifacts in the verify phase, which means signing will happen for the <code>install</code> 
and <code>deploy</code> targets, but not the <code>package</code> target. When performing a local test build, if you do <code>mvn clean install site</code> it will test the signing process. 
If you do not have the certificate installed, you can instead to <code>mvn clean package site</code> to bypass signing, but this 
provides less certainty that everything is set up correctly for the CI-driven final release.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../js/version-select.js" defer></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
